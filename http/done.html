<!doctype html>
<html>
  <head>
      <meta charset="utf-8">
      <title>Uploading spreadsheet</title>
      <meta name="author" content="ScraperWiki Ltd">

      <link rel="stylesheet" href="//beta.scraperwiki.com/vendor/style/bootstrap.min.css">
      <link rel="stylesheet" href="//beta.scraperwiki.com/style/scraperwiki.css">
      <link rel="stylesheet" href="style.css">

      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.2/coffee-script.min.js"></script>
      <script src="//beta.scraperwiki.com/vendor/js/bootstrap.min.js"></script>
      <script src="//beta.scraperwiki.com/js/scraperwiki.js"></script>

      <meta http-equiv="cleartype" content="on">
  </head>
  <body>
    <p class="loading">Structuring your data&hellip;</p>
    <script type="text/coffeescript">
      $ ->
        settings = scraperwiki.readSettings()
        scraperwiki.exec(
          "cd; python */code/extract.py ~/incoming/#{settings.filePath} 2>>extract.log")
          .done( (data) ->
            $('p.loading').remove()
            try
              obj = JSON.parse(data)
            catch error
              scraperwiki.alert("Unexpected output returned from extraction script", error, 1)
              $('body').append("""<a href="./#{location.hash}" class="btn btn-primary">Try again!</a>""")
              return false

            if obj.errorType?
              scraperwiki.alert("Oh no!", "We received an error from the extraction script: #{obj.errorMessage}", 1)
              $('body').append("""<a href="./#{location.hash}" class="btn btn-primary">Try again!</a>""")
            else
              scraperwiki.tool.redirect "/dataset/#{scraperwiki.box}"

          ).fail( (jqXHR, textStatus, errorThrown) ->
            $('p.loading').remove()
            scraperwiki.alert("Failed to contact box server", errorThrown, 1)
            $('body').append("""<a href="./#{location.hash}" class="btn btn-primary">Try again!</a>""")
          )

    </script>
  </body>
</html>

