<!doctype html>
<html>
  <head>
      <meta charset="utf-8">
      <title>Uploading spreadsheet</title>
      <meta name="author" content="ScraperWiki Ltd">

      <link rel="stylesheet" href="//beta.scraperwiki.com/vendor/style/bootstrap.min.css">
      <link rel="stylesheet" href="//beta.scraperwiki.com/style/scraperwiki.css">
      <link rel="stylesheet" href="style.css">

      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.2/coffee-script.min.js"></script>
      <script src="//beta.scraperwiki.com/vendor/js/bootstrap.min.js"></script>
      <script src="//beta.scraperwiki.com/js/scraperwiki.js"></script>

      <meta http-equiv="cleartype" content="on">
  </head>
  <body>
    <p class="loading">Reading your spreadsheet&hellip;</p>
    <script type="text/coffeescript">

      showAlert = (title, message, level) ->
        # [title] and [message] should be html strings. The first is displayed in bold.
        # If [level] is a truthful value, the alert is printed in red.
        level = level or 0
        $div = $("<div>").addClass("alert").text message
        $div.prepend '<button type="button" class="close" data-dismiss="alert">Ã—</button>'
        $div.prepend "<strong>#{title}</strong> "
        $div.addClass("alert-error") if level
        $div.prependTo "body"

      $ ->
        settings = scraperwiki.readSettings()
        scraperwiki.exec(
          "cd; python */code/extract.py ~/incoming/#{settings.filePath} 2>>extract.log")
          .done( (data) ->
            $('p.loading').remove()
            try
              obj = JSON.parse(data)
            catch error
              showAlert("Unexpected output returned from extraction script", error, 1)
              $('body').append("""<a href="index.html#{location.hash}" class="btn btn-primary">Try again!</a>""")
              return false
          
            if obj.result?
              scraperwiki.tool.redirect "/dataset/#{scraperwiki.box}"
            else
              showAlert("Oh no!", "We received an error from the extraction script: #{obj.error}", 1)
              $('body').append("""<a href="index.html#{location.hash}" class="btn btn-primary">Try again!</a>""")

          ).fail( (jqXHR, textStatus, errorThrown) ->
            $('p.loading').remove()
            showAlert("Failed to contact box server", errorThrown, 1)
            $('body').append("""<a href="index.html#{location.hash}" class="btn btn-primary">Try again!</a>""")
          )

    </script>
  </body>
</html>

